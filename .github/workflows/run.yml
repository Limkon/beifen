name: fetch-website-content

on:
  workflow_dispatch:
  
  schedule:
    - cron: '0 23 * * *'

jobs:
  fetch-website-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout 代码库
        uses: actions/checkout@v3
        with:
          ref: ${{ github.head_ref }}

      - name: 安装 Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'

      - name: 安装依赖
        run: npm install puppeteer moment

      - name: 读取链接
        run: cat urls > urls_tmp

      - name: 调用 read_website.js
        run: node read_website.js

      name: 爬取网页

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  fetch-webpage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "14.x"
      - name: Install dependencies
        run: |
          npm install moment puppeteer-core
      - name: Compile Chromium on Ubuntu
        run: |
          sudo apt-get update
          sudo apt-get install chromium-browser
      - name: Set up X11 display
        run: |
          sudo apt-get install xvfb
          Xvfb :99 &
          export DISPLAY=:99
      - name: Set up Puppeteer
        run: |
          export PUPPETEER_EXECUTABLE_PATH=$(which chromium-browser)
          export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
          export PUPPETEER_DOWNLOAD_HOST=https://storage.googleapis.com.cnpmjs.org
      - name: 爬取网页
        id: fetch-webpage
        run: |
          node read_website.js
        env:
          GITHUB_RUN_ID: ${{ github.run_id }}


      - name: 设置 Git 配置
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: 拉取远程仓库的更改
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Pull latest changes from remote repository"
          commit_options: "--no-verify"
          branch: ${{ github.head_ref }}

      - name: 提交文件到主分支
        continue-on-error: true
        run: |
          git add data
          git commit -m 'Add website content'
          git push origin HEAD:${{ github.head_ref }}
